[toc]

# 《图解网络》

## 一、网络基础篇

### 1.1 TCP/IP网络模型有哪几层？

同设备内进程通信可通过管道、消息队列、共享内存、信号等方式，而不同设备间进程通信需要通过网络通信，而设备多种多样，要兼容多种设备，就需要有一套通用的网络协议。

网络协议是分层的，各层有各自的功能职责。TCP/IP网络模型分层：**应用层、传输层、网络层、网络接口层**。

**1. 应用层**

**应用层（Application Layer）**只专注于为用户提供应用功能，如HTTP、FTP、Telnet、DNS、SMTP等，不关心数据的传输，数据交给下一层去处理。

应用层工作与操作系统的**用户态**，传输层及以下则工作于**内核态**。

**2. 传输层**

**传输层（Transport Layer）**接收应用层传输来的数据包，或将收到的数据包发送给应用层，为应用层提供网络支持。

传输层有**TCP（传输控制协议Transmission Control Protocol）**和**UDP（用户数据报协议User Datagram Protocol）**两种传输协议。

TCP协议保证数据包能**可靠传输**到接收端，相比UDP协议多了**流量控制、超时重传、拥塞控制**等特性。大部分应用都使用TCP，如HTTP。传输数据较大时，直接传输并不好控制，因此当传输层数据包大小超过**MSS（TCP最大报文段长度）**就将数据包分块传输，某个块损坏或丢失时只需要重传这一个块。TCP中每个分块称一个**TCP段（TCP Segment）**。

UDP协议相对简单，只负责发送数据包，不保证数据包抵达接收端，但实时性更好，传输效率也高。UDP当然也可以实现可靠传输，将TCP的特性在应用层上实现就可以，不过实现一个商用的可靠UDP传输协议并不简单。

一台设备可能会有多个应用在接收或传输数据，需要通过**端口**来区分应用，如Web服务器用80端口、远程登录服务器用22端口等。浏览器中每个标签栏都是一个独立的进程，操作系统会为这些进程临时分配端口。传输层报文中携带了端口号。

**3. 网络层**

网络中存在各样的线路和分叉路口，数据的传输需要对各种路径和节点进行选择（路由），而传输层的设计理念是简单、高效、专注，并不负责这部分的功能。传输层只需服务好应用层，实际的传输工作交给下一层网络层。

**网络层（Internet Layer）**常用**IP协议（Internet Protocol）**，IP协议将传输层报文作为数据部分，加上IP包头组成**IP报文**，IP报文大小超过**MTU（最大传输单元Maximum Transmission Unit，以太网中一般1500字节）**则再次分片。

<img src="C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\IP报文组成.png" style="zoom:50%;" />

网络中使用**IP地址**区分设备，对**IPv4协议**，IP地址共32位，分四段，每段8位，如192.168.100.1。

为便于寻址，将IP地址划分为两段，前n位作**网络号**，后32-n位作**主机号**。网络号标识IP地址属于哪个子网，主机号标识同一子网内不同主机。寻址中先匹配网络号，后找对应主机。

网络号和主机号通过**子网掩码**来划分，如192.168.100.1/24，/24就是子网掩码255.255.255.0，即前24位为网络号，后8位为主机号。通过IP地址与子网掩码按位与运算可以得到网络号，子网掩码的取反后与IP地址按位与运算则是主机号。

**寻址通过IP地址确定目标设备的位置，而数据包从源到目的地的过程则由路由负责**。实际中，设备间需要通过许多网关、路由器、交换机等众多网络设备连接，会形成很多条网络路径，需要路由算法来决定最佳路径。

**4. 网络接口层**

**网络接口层（Link Layer）**从网络层收到IP报文后再IP头部加上**MAC**（媒体存取控制位址Media Access Control Address）头部，并封装成**数据帧（Data frame）**发送到网络上。

IP头部中接收方IP地址表示网络包的目的地，但在以太网内便行不通了。以太网是一种在局域网内的，将周围设备连接起来，使它们之间进行通信的技术，包括了以太网接口、Wi-Fi接口、以太网交换机、路由器的千兆万兆以太网口、网线。

以太网中通过MAC地址来识别设备，因此数据帧的MAC头部包含了接收方和发送方的MAC地址，通过ARP协议可获取对方的MAC地址。

网络接口层位网络层提供「链路级别」传输的服务，负责在以太网、WiFi 这样的底层网络上发送原始数据包，工作在网卡这个层次，使用 MAC 地址来标识网络上的设备。

**5. 总结**

TCP/IP 网络通常是由上到下分成 4 层，分别是**应用层，传输层，网络层和网络接口层**。

![img](.\img\基础篇\tcpip参考模型.drawio.png)

每一层封装格式：

![img](.\img\基础篇\封装.png)

网络接口层的传输单位是帧（frame），IP 层的传输单位是包（packet），TCP 层的传输单位是段（segment），HTTP 的传输单位则是消息或报文（message）。但这些名词并没有什么本质的区分，可以统称为数据包。

- 比特流bit：物理层
- 数据帧frame：数据链路层
- 数据包/报文分组packet：网络层
- 数据报datagram：传输层UDP
- 数据段segment：传输层TCP
- 消息/报文message：应用层

### 1.2 键入网址到网页显示，期间发生了什么？

**1. HTTP**

![URL 解析](.\img\基础篇\URL组成.png)



![HTTP 的消息格式](.\img\基础篇\HTTP请求报文和响应报文.png)



**2. DNS**

![域名解析的工作流程](.\img\基础篇\DNS域名解析.png)



**3. 协议栈**

![img](.\img\基础篇\协议栈.png)



**4. 可靠传输——TCP**

![TCP 包头格式](.\img\基础篇\TCP报文头格式.png)



![TCP 三次握手](.\img\基础篇\TCP三次握手.png)



![MTU 与 MSS](.\img\基础篇\MTU与MSS.jpg)



![数据包分割](.\img\基础篇\HTTP数据拆分.jpg)



![TCP 层报文](.\img\基础篇\TCP报文格式.jpg)



**5. 远程定位——IP**

![IP 包头格式](.\img\基础篇\IP包头格式.jpg)



![路由规则判断](.\img\基础篇\路由规则判断.jpg)



![IP 层报文](.\img\基础篇\IP层报文格式.jpg)



**6. 两点传输——MAC**

![MAC 包头格式](.\img\基础篇\MAC包头格式.jpg)



![ARP 广播](.\img\基础篇\ARP广播.jpg)

如果源和目标不是在同一子网，则MAC地址可以使用广播地址（全1，FF-FF-FF-FF-FF-FF）或组播地址（第8bit为1）。



![MAC 层报文](.\img\基础篇\MAC报文格式.jpg)



**7. 出口——网卡**

![数据包](.\img\基础篇\网卡数据包发送.png)



**8. 送别者——交换机**

![交换机的 MAC 地址表](.\img\基础篇\交换机的MAC地址表.jpg)



**9. 出境大门——路由器**

![路由器转发](.\img\基础篇\路由器转发.jpg)



**10. 互相扒皮——服务器与客户端**

![网络分层模型](.\img\基础篇\网络分层模型.jpg)





### 1.3 Linux系统是如何收发网络包的？

**1. 网络模型**



**2. Linux网络协议栈**

![img](.\img\基础篇\Linux网络协议栈.png)



**3. Linux接收网络包的流程**

![img](.\img\基础篇\Linux网络包收发流程.png)



**4. Linux发送网络包的流程**

![img](.\img\基础篇\网络包收发使用sk_buff.jpg)



## 二、HTTP篇

### 2.1 HTTP常见面试题

![提纲](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\HTTP篇\HTTP提纲.png)



**1. HTTP基本概念**

**HTTP是什么？**

**HTTP常见的状态码有哪些？**

![ 五大类 HTTP 状态码 ](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\HTTP篇\五大类HTTP状态码.png)



**HTTP常见字段有哪些？**

Host

Content-Length

Connection

Content-Type

Content-Encoding



**2. GET与POST**

**GET和POST有什么区别**

**GET和POST方法都是安全和幂等的吗？**



**3. HTTP缓存技术**

**HTTP缓存有哪些实现方式？**

**什么是强制缓存？**



**4. HTTP特性**

**HTTP/1.1的优点有哪些？**

**HTTP/1.1的缺点有哪些？**

**HTTP/1.1的性能如何？**



**5. HTTP与HTTPS**

**HTTP与HTTPS有哪些区别？**

**HTTPS解决了HTTP的哪些问题？**

**HTTPS是如何建立连接的？期间交互了什么？**

**HTTPS的应用数据是如何保证完整性的？**

**HTTPS一定安全可靠吗？**



**6. HTTP/1.1、HTTP/2、HTTP/3演变**

**HTTP/1.1相比HTTP/1.0提高了什么性能？**

**HTTP/2做了什么优化？**

**HTTP/3做了哪些优化？**





### 2.2 HTTP/1.1如何优化？

![img](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\HTTP篇\优化http1.1提纲.png)



**1. 如何避免发送HTTP请求？**

**2. 如何减少HTTP请求次数？**

**减少重定向请求次数**

**合并请求**

**延迟发送请求**

**3. 如何减少HTTP响应的数据大小？**

**无损压缩**

**有损压缩**

**4. 总结**



### 2.3 HTTPS RSA握手解析

![img](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\HTTP篇\https RSA握手解析提纲.png)



**1. TLS握手过程**

**2. RSA握手过程**

**TLS第一次握手**

**TLS第二次握手**

**客户端验证证书**

**TLS第三次握手**

**TLS第四次握手**

**RSA算法的缺陷**





### 2.4 HTTPS ECDHE握手解析

![img](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\HTTP篇\ECDHE握手协议提纲.png)



**1. 离散对数**

**2. DH算法**

**3. DHE算法**

**4. ECDHE算法**

**5. ECDHE握手过程**

**TLS第一次握手**

**TLS第二次握手**

**TLS第三次握手**

**TLS第四次握手**





### 2.5 HTTPS如何优化？

![img](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\HTTP篇\优化https提纲.png)



**1. 分析性能损耗**

**2. 硬件优化**

**3. 软件优化**

**4. 协议优化**

**密钥交换算法优化**

**TLS升级**

**5. 证书优化**

**证书传输优化**

**证书验证优化**

**6. 会话复用**

**Session ID**

**Session Ticket**

**Pre-shared Key**

**7. 总结**



### 2.6 HTTP/2牛逼在哪？

![img](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\HTTP篇\HTTP2优势提纲.png)



**1. HTTP/1.1协议的性能问题**

**2. 兼容HTTP/1.1**

**3. 头部压缩**

**静态表编码**

**动态表编码**

**4. 二进制帧**

**5. 并发传输**

**6. 服务器主动推送资源**

**7. 总结**



### 2.7 HTTP/3强势来袭

![image-20240105144308801](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\HTTP篇\HTTP3强势来袭提纲.png)



**1. 美中不足的HTTP/2**

**队头阻塞**

**TCP与TLS的握手时延迟**

**网络迁移需要重新连接**

**2. QUIC协议的特点**

**无队头阻塞**

**更快的连接建立**

**连接迁移**

**3. HTTP/协议**

**4. 总结**





### 2.8 既然有HTTP协议，为什么还要有RPC？

**1. 从TCP聊起**

**2. HTTP和RPC**

**3. HTTP和RPC有什么区别**

**服务发现**

**底层连接形式**

**传输的内容**

**4. 总结**




### 2.9 既然有HTTP协议，为什么还要有WebSocket？

**1. 使用HTTP不断轮询**

**2. 长轮询**

**3. WebSocket是什么**

**怎么建立WebSocket连接**

**WebSocket消息格式**

**WebSocket使用场景**

**4. 总结**





## 三、TCP篇

### 3.1 TCP三次握手与四次挥手面试题

![img](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\TCP篇\TCP三次握手与四次挥手面试题提纲.png)

**1. TCP基本认识**

**TCP头格式有哪些？**

**为什么需要TCP协议？TCP工作在哪一层？**

**什么是TCP？**

**什么是TCP连接？**

**如何唯一确定一个TCP连接？**

**UDP和TCP有什么区别呢？分别的应用场景？**

**TCP和UDP可以使用同一个端口吗？**



**2. TCP连接建立**

**TCP三次握手过程是怎样的？**

**如何在Linux系统查看TCP状态？**

**为什么是三次握手？不是两次、四次？**

**为什么每次建立TCP连接时，初始化的序列号都要求不一样呢？**

**既然IP层会分片，为什么TCP层还需要MSS呢？**

**第一次握手丢失，会发生什么？**

**第二次握手丢失，会发生什么？**

**第三次握手丢失，会发生什么？**

**什么是SYN攻击？如何避免SYN攻击？**



**3. TCP连接断开**

**TCP四次挥手过程是怎样的？**

**为什么挥手需要四次？**

**第一次挥手丢失了，会发生什么？**

**第二次挥手丢失了，会发生什么？**

**第三次挥手丢失了，会发生什么？**

**第四次挥手丢失了，会发生什么？**

**为什么TIME_WAIT等待时间是2MSL？**

**为什么需要TIME_WAIT状态？**

**TIME_WAIT过多有什么危害？**

**如何优化TIME_WAIT？**

**服务器出现大量TIME_WAIT状态的原因有哪些？**

**服务器出现大量CLOSE_WAIT状态的原因有哪些？**

**如果已经建立了连接，但是客户端突然出现故障了怎么办？**

**如果已经建立了连接，但是服务端的进程崩溃会发生什么？**



**4. Socket编程**

**针对TCP应该如何Socket编程？**

**listen时候参数backlog的意义？**

**accept发生在三次握手的哪一步？**

**客户端调用close了，连接是断开的流程是什么？**

**没有accept，能建立TCP连接吗？**

**没有listen，能建立TCP连接吗？**



### 3.2 TCP重传、滑动窗口、流量控制、拥塞控制

![img](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\TCP篇\TCP可靠性的保证机制提纲.jpg)



**1. 重传机制**

**超时重传**

**快速重传**

**SACK方法**

**Duplicate SACK**



**2. 滑动窗口**

**3. 流量控制**

**操作系统缓冲区与滑动窗口的关系**

**窗口关闭**

**糊涂窗口综合症**



**4. 拥塞控制**

**慢启动**

**拥塞避免算法**

**拥塞发生**

**快速恢复**



### 3.3 TCP实战抓包分析

![提纲](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\TCP篇\TCP实战抓包分析提纲.jpg)



**1. 显形“不可见”的网络包**

**2. 解密TCP三次握手和四次挥手**

**3. TCP三次握手异常情况实战分析**

**实验场景**

**实验一：TCP第一次握手SYN丢包**

**实验二：TCP第二次握手SYN、ACK丢包**

**实验三：TCP第三次握手ACK丢包**

**4. TCP快速建立连接**

**5. TCP重复确认和快速重传**

**6. TCP流量控制**

**零窗口通知与窗口探测**

**发送窗口的分析**

**7. TCP延迟确认与Nagle算法**

**读者问答**



### 3.4 TCP半连接队列和全连接队列

![本文提纲](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\TCP篇\TCP半连接队列和全连接队列提纲.jpg)



**1. 什么是TCP半连接队列和全连接队列**

**2. 实战 - TCP全连接队列溢出**

**3. 实战 - TCP半连接队列溢出**



### 3.5 如何优化TCP？

![本节提纲](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\TCP篇\优化TCP提纲.jpg)



**1. TCP三次握手的性能提升**

**客户端优化**

**服务端优化**

**如何绕过三次握手？**



**2. TCP四次挥手的性能提升**

**主动方的优化**

**被动方的优化**



**3. TCP传输数据的性能提升**

**滑动窗口是如何影响传输速度的？**

**如何确定最大传输速度？**

**怎么调整缓冲区大小?**



### 3.6 如何理解是TCP面向字节流协议？

**1. 如何理解字节流？**

**2. 如何解决粘包？**

**固定长度的消息**

**特殊字符作为边界**

**自定义消息结构**



### 3.7 为什么TCP每次建立连接时，初始化序列号都要不一样呢？



### 3.8 SYN报文什么情况下会被丢弃？

**1. 坑爹的tcp_tw_recycle**

**2. accept列表满了**

**半连接队列满了**

**全连接队列满了**



**3.9 已建立连接的TCP，收到SYN会发生什么？**

**1. RFC文档解释**

**2. 源码分析**

**3. 如何关闭一个TCP连接？**

**killcx的工具**

**tcpkill的工具**

**4. 总结**



### 3.10 四次挥手中收到乱序的FIN包会如何处理？

**1. TCP源码分析**

**2. 怎么看TCP源码？**



### 3.11 在TIME_WAIT状态的TCP连接，收到SYN后会发生什么？

**1. 先说结论**

**收到合法SYN**

**收到非法的SYN**

**2. 源码分析**

**3. 在TIME_WAIT状态， 收到RST会断开连接吗？**

**4. 总结**



### 3.12 TCP连接，一端断电和进程崩溃有什么区别？

**1. 主机崩溃**

**2. 进程崩溃**

**3. 有数据传输的场景**

**客户端主机宕机，又迅速重启**

**客户端主机宕机，一直没有重启**

**4. 总结**



### 3.13 拔掉网线后，原本的TCP连接还存在吗？

**1. 拔掉网线后，有数据传输**

**2. 拔掉网线后，没有数据传输**



### 3.14 tcp_tw_reuse为什么默认是关闭的？

**1. 什么是TIME_WAIT状态？**

**2. 为什么要设计TIME_WAIT状态？**

**3. tcp_tw_reuse是什么？**

**4. 为什么tcp_tw_reuse默认是关闭的？**

**第一个问题**

**第二个问题**



### 3.14 HTTPS中TLS和TCP能同时握手吗？

**1. TCP Fast Open**

**2. TLSv1.3**



### 3.15 TCP Keepalive和HTTP Keep-Alive是一个东西吗？

**1. HTTP的Keep-Alive**

**2. TCP的Keepalive**



### 3.16 TCP协议有什么缺陷？

**1. 升级TCP的工作很困难**

**2. TCP建立连接的延迟**

**3. TCP存在队头阻塞问题**

**4. 网络迁移需要重新建立TCP连接**

**5. 结尾**



### 3.17 如何基于UDP协议实现可靠传输？

![img](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\TCP篇\QUIC提纲.png)



**1. QUIC是如何实现可靠传输的？**

**Packet Header**

**QUIC Frame Header**



**2. QUIC是如何解决TCP队头阻塞问题的？**

**什么是TCP队头阻塞问题？**

**HTTP/2的队头阻塞**

**没有队头阻塞的QUIC**



**3. QUIC是如何做流量控制的？**

**Stream级别的流量控制**

**Connection流量控制**



**4. QUIC对拥塞控制改进**

**5. QUIC更快的连接建立**

**6. QUIC是如何迁移连接的？**



### 3.18 TCP和UDP可以使用同一个端口吗？

**1. TCP和UDP可以同时绑定相同的端口吗？**

**2. 多个TCP服务进程可以绑定同一个端口吗？**

**3. 客户端的端口可以重复使用吗？**

**4. 总结**



### 3.19 服务端没有listen，客户端发起连接建立，会发生什么？

**1. 做个实验**

**2. 源码分析**

**3. 没有listen，能建立TCP连接吗？**



### 3.20 没有accept，能建立TCP连接吗？

**1. 三次握手的细节分析**

**半连接队列、全连接队列是什么**

**为什么半连接队列要设计成哈希表**

**怎么观察两个队列的大小**

**全连接队列满了会怎么样？**

**半连接队列要是满了会怎么样？**

**没有listen，为什么还能建立连接**

**2. 总结**



### 3.21 用了TCP协议，数据一定不会丢吗？

**1. 数据包的发送流程**

**2. 建立连接时丢包**

**3. 流量控制丢包**

**4. 网卡丢包**

**RingBuffer过小导致丢包**

**网卡性能不足**

**5. 接收缓冲区丢包**

**6. 两端之间的网络丢包**

**7. 发生丢包了怎么办**

**8. 用了TCP协议就一定不会丢包吗**

**9. 这类丢包问题怎么解决？**

**10. 总结**



### 3.22 TCP四次挥手，可以变成三次吗？

**1. TCP四次挥手**

**为什么TCP挥手需要四次呢？**

**粗暴关闭vs优雅关闭**

**2. 什么情况会出现三次挥手**

**实验验证**

**3. 总结**



### 3.23 TCP序列号和确认号是如何变化的？

**1. 万能公式**

发送的TCP报文：

- 公式一：序列号 = 上一次发送的序列号 + len（数据长度）。没携带数据下，SYN报文或FIN报文的数据长度算1，ACK报文算0
- 公式二：确认号 = 上一次收到的报文中的序列号 + len（数据长度）。没携带数据下，SYN报文或FIN报文的数据长度算1，ACK报文算0

**2. 三次握手阶段的变化**

**3. 数据传输阶段的变化**

**4. 四次挥手阶段的变化**

![在这里插入图片描述](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\TCP篇\四次挥手序列号和确认号变化.png)



**5. 实际抓包图**





## 四、IP篇

### 4.1 IP基础知识全家桶

![IP 基础知识全家桶](C:\Users\hp-pc\Desktop\实习备战记\计算机网络\img\IP篇\IP基础知识提纲.jpg)



**1. 前菜 - IP基本认识**

**2. 主菜 - IP地址的基础知识**

**IP地址的分类**

**无分类地址CIDR**

**公有IP地址与私有IP地址**

**IP地址与路由控制**

**IP分片与重组**

**IPv6基本认识**

**IPv4首部与IPv6首部**

**3. 点心 - IP协议相关技术**

**DNS**

**ARP**

**DHCP**

**NAT**

**ICMP**

**IGMP**



### 4.2 ping的工作原理

 **1. IP协议的助手 - ICMP协议**

**2. 查询报文类型**

**3. 差错报文类型**

**4. ping - 查询报文类型的使用**

**5. traceroute - 差错报文类型的使用**



### 4.3 断网了，还能ping通127.0.0.1吗？

**1. 什么是127.0.0.1**

**2. 什么是ping**

**3. TCP发数据和ping的区别**

**4. 为什么断网了还能ping通127.0.0.1**

**5. ping回环地址和ping本机地址有什么区别**

**6. 127.0.0.1和localhost以及0.0.0.0有区别吗**







## 五、学习方法

### 5.1 入门系列

**《图解HTTP》**

**《图解TCP/IP》**

**《网络是怎样连接的》**

[《计算机网络微课堂》](https://www.bilibili.com/video/BV1c4411d7jb?p=1)

### 5.2  深入学习系列

**《计算机网络 - 自顶向下方法》**

**《TCP/IP详解 卷一：协议》**

**《The TCP/IP GUIDE》**

[TCP协议的RFC文档](https://datatracker.ietf.org/doc/rfc1644/)

### 5.3 实战系列

**《Wireshark网络分析就这么简单》**

**《Wireshark网络分析的艺术》**

